<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lite IDE</title>
    <!-- 路径指向 main.py 挂载的 /vscode -->
    <link rel="stylesheet" href="/vscode/out/vs/workbench/workbench.web.main.css" />
    <style>
        /* 深度精简 UI */
        .action-item:has(a[aria-label*="Menu"]), .activitybar .content .home-bar,
        .action-item:has(a[aria-label*="Source Control"]), .action-item:has(a[aria-label*="Run and Debug"]),
        .action-item:has(a[aria-label*="Extensions"]), .action-item:has(a[aria-label*="Accounts"]),
        .action-item:has(a[aria-label*="Manage"]), 
        .pane-header:has(h3[title*="Outline"]), .pane-header:has(h3[title*="Timeline"]) { display: none !important; }
    </style>
</head>
<body style="margin:0;overflow:hidden;">
    <script src="/vscode/out/vs/loader.js"></script>
    <script>require.config({baseUrl: `${window.location.origin}/vscode/out`});</script>
    <script src="/vscode/out/nls.messages.js"></script>
    <script src="/vscode/out/vs/workbench/workbench.web.main.js"></script>
    <script>
        require(['vs/workbench/workbench.web.main'], function (wb) {
            const USER_ID = "default_user"; 

            class SQLiteFSProvider {
                constructor() { this.capabilities = 2; this.onDidChangeFile = new wb.Emitter().event; }
                watch() { return { dispose: () => {} }; }
                async stat(uri) { return fetch(`/api/vfs/stat?user_id=${USER_ID}&path=${encodeURIComponent(uri.path)}`).then(res => res.json()); }
                async readDirectory(uri) { return fetch(`/api/vfs/readdir?user_id=${USER_ID}&path=${encodeURIComponent(uri.path)}`).then(res => res.json()); }
                async readFile(uri) {
                    const res = await fetch(`/api/vfs/read?user_id=${USER_ID}&path=${encodeURIComponent(uri.path)}`);
                    return new Uint8Array(await res.arrayBuffer());
                }
                async writeFile(uri, content) { await fetch(`/api/vfs/write?user_id=${USER_ID}&path=${encodeURIComponent(uri.path)}`, { method: 'POST', body: content }); }
                async createDirectory(uri) { await fetch(`/api/vfs/mkdir?user_id=${USER_ID}&path=${encodeURIComponent(uri.path)}`, { method: 'POST' }); }
                async delete(uri) { await fetch(`/api/vfs/delete?user_id=${USER_ID}&path=${encodeURIComponent(uri.path)}`, { method: 'DELETE' }); }
            }

            wb.create(window.document.body, {
                productConfiguration: { extensionsGallery: undefined },
                configurationDefaults: {
                    "workbench.statusBar.visible": false,
                    "window.menuBarVisibility": "hidden",
                    "outline.enabled": false,
                    "timeline.enabled": false,
                    "workbench.view.explorer.visible": true,
                    "workbench.view.search.visible": true
                },
                fileSystemProviders: [{ scheme: 'sqlite', provider: new SQLiteFSProvider() }],
                folderUri: wb.URI.parse('sqlite:/'),
                workspaceProvider: {
                    trusted: true,
                    workspace: { folderUri: wb.URI.parse('sqlite:/') },
                    async open() { return true; }
                }
            });

            // 右键菜单清理
            const cleanup = () => {
                const menu = document.querySelector('.monaco-menu-container');
                if (!menu) return;
                menu.querySelectorAll('.action-item').forEach(item => {
                    const txt = item.innerText || "";
                    if (/Menu|Source Control|Run and Debug|Extensions|Accounts|Outline|Timeline|Move Primary|Hide Activity/.test(txt)) {
                        item.style.setProperty('display', 'none', 'important');
                    }
                    if (txt.trim() === "" && item.classList.contains('disabled')) item.style.display = 'none';
                });
            };
            new MutationObserver(() => setTimeout(cleanup, 20)).observe(document.body, { childList: true, subtree: true });
        });
    </script>
</body>
</html>